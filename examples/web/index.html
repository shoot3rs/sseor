<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction SSE Client</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .event-log { background: #f5f5f5; padding: 15px; margin: 15px 0; border-radius: 5px; max-height: 400px; overflow-y: auto; }
        .event { margin: 5px 0; padding: 8px; border-left: 3px solid #007bff; background: white; }
        .event.error { border-left-color: #dc3545; }
        .event.success { border-left-color: #28a745; }
        .controls { margin: 20px 0; }
        input, button { padding: 10px; margin: 5px; border: 1px solid #ddd; border-radius: 3px; }
        button { background: #007bff; color: white; cursor: pointer; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
    </style>
</head>
<body>
<div class="container">
    <h1>Transaction SSE Client</h1>

    <div class="controls">
        <input type="text" id="userIdInput" placeholder="User ID (e.g., user123)" value="user123">
        <button id="connectBtn" onclick="connectSSE()">Connect to SSE</button>
        <button id="disconnectBtn" onclick="disconnectSSE()" disabled>Disconnect</button>
        <button id="testDepositBtn" onclick="testDeposit()" disabled>Test Deposit</button>
    </div>

    <div>
        <h3>Connection Status: <span id="status">Disconnected</span></h3>
        <p>Active Connections: <span id="connectionCount">0</span></p>
    </div>

    <div class="event-log" id="eventLog">
        <div class="event">Ready to connect...</div>
    </div>
</div>

<script>
    let eventSource = null;
    let userId = 'user123';
    let reconnectAttempts = 0;
    let maxReconnectAttempts = 5;
    let reconnectDelay = 1000; // Start with 1 second

    function updateStatus(status, isConnected = false) {
        document.getElementById('status').textContent = status;
        document.getElementById('connectBtn').disabled = isConnected;
        document.getElementById('disconnectBtn').disabled = !isConnected;
        document.getElementById('testDepositBtn').disabled = !isConnected;
    }

    function addEvent(message, type = 'info') {
        const eventLog = document.getElementById('eventLog');
        const eventDiv = document.createElement('div');
        eventDiv.className = `event ${type}`;
        eventDiv.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
        eventLog.appendChild(eventDiv);
        eventLog.scrollTop = eventLog.scrollHeight;
    }

    function connectSSE(isReconnect = false) {
        userId = document.getElementById('userIdInput').value || 'user123';
        const url = `http://localhost:9090/api/v1/sse/transactions?user_id=${userId}`;

        if (!isReconnect) {
            addEvent(`Connecting to SSE: ${url}`);
            reconnectAttempts = 0;
        } else {
            addEvent(`Attempting reconnection ${reconnectAttempts + 1}/${maxReconnectAttempts}...`);
        }

        updateStatus('Connecting...');

        eventSource = new EventSource(url);

        eventSource.onopen = function(event) {
            updateStatus('Connected', true);
            const message = isReconnect ? '‚úÖ Reconnected to SSE stream' : '‚úÖ Connected to SSE stream';
            addEvent(message, 'success');
            reconnectAttempts = 0; // Reset reconnection attempts on successful connection
            reconnectDelay = 1000; // Reset delay
        };

        eventSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                addEvent(`üì® Message: ${JSON.stringify(data, null, 2)}`);
            } catch (e) {
                addEvent(`üì® Raw message: ${event.data}`);
            }
        };

        eventSource.addEventListener('connected', function(event) {
            try {
                const data = JSON.parse(event.data);
                addEvent(`üîó Connected: ${JSON.stringify(data, null, 2)}`, 'success');
            } catch (e) {
                addEvent(`üîó Connected: ${event.data}`, 'success');
            }
        });

        eventSource.addEventListener('heartbeat', function(event) {
            // Only log heartbeat occasionally to avoid spam
            if (Math.random() < 0.1) { // 10% chance to log
                addEvent('üíì Heartbeat received (connection alive)');
            }
        });

        eventSource.addEventListener('transaction.created', function(event) {
            try {
                const data = JSON.parse(event.data);
                addEvent(`üÜï Transaction Created: ${data.transaction.id} - ${data.message}`, 'success');
            } catch (e) {
                addEvent(`üÜï Transaction Created: ${event.data}`, 'success');
            }
        });

        eventSource.addEventListener('transaction.status_updated', function(event) {
            try {
                const data = JSON.parse(event.data);
                addEvent(`üîÑ Status Update: ${data.transaction.status} - ${data.message}`);
            } catch (e) {
                addEvent(`üîÑ Status Update: ${event.data}`);
            }
        });

        eventSource.addEventListener('transaction.completed', function(event) {
            try {
                const data = JSON.parse(event.data);
                addEvent(`‚úÖ Transaction Completed: ${data.transaction.id} - ${data.message}`, 'success');
            } catch (e) {
                addEvent(`‚úÖ Transaction Completed: ${event.data}`, 'success');
            }
        });

        eventSource.onerror = function(event) {
            if (eventSource.readyState === EventSource.CLOSED) {
                updateStatus('Connection Closed', false);
                addEvent('üîå Connection closed by server', 'error');

                // Attempt automatic reconnection
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    addEvent(`‚è≥ Reconnecting in ${reconnectDelay / 1000} seconds...`);

                    setTimeout(() => {
                        connectSSE(true); // Reconnect
                    }, reconnectDelay);

                    // Exponential backoff for reconnection delay
                    reconnectDelay = Math.min(reconnectDelay * 2, 30000); // Max 30 seconds
                } else {
                    addEvent('‚ùå Max reconnection attempts reached. Please refresh or click connect again.', 'error');
                    updateStatus('Disconnected - Manual reconnect needed', false);
                }
            } else {
                updateStatus('Connection Error', false);
                addEvent('‚ùå SSE connection error', 'error');
            }
            console.error('SSE error:', event);
        };
    }

    function disconnectSSE() {
        if (eventSource) {
            eventSource.close();
            eventSource = null;
            updateStatus('Disconnected', false);
            addEvent('üîå Disconnected from SSE stream', 'error');
        }
    }

    async function testDeposit() {
        try {
            addEvent('üöÄ Initiating test deposit...');

            const response = await fetch('http://localhost:8080/api/v1/transactions/deposit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: userId,
                    amount: Math.floor(Math.random() * 1000) + 100 // Random amount between 100-1099
                })
            });

            if (response.ok) {
                const result = await response.json();
                addEvent(`üí∞ Deposit initiated: ${JSON.stringify(result, null, 2)}`, 'success');
            } else {
                const error = await response.text();
                addEvent(`‚ùå Deposit failed: ${error}`, 'error');
            }
        } catch (error) {
            addEvent(`‚ùå Network error: ${error.message}`, 'error');
        }
    }

    // Auto-connect on page load
    window.addEventListener('load', function() {
        addEvent('Page loaded. Click "Connect to SSE" to start receiving transaction updates.');
    });
</script>
</body>
</html>